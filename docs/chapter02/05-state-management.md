---
title: ä¼šè¯è·Ÿè¸ªæŠ€æœ¯ (Cookie & Session)
---

# 4. ä¼šè¯è·Ÿè¸ªæŠ€æœ¯ (Cookie & Session)

!!! quote "æœ¬èŠ‚ç›®æ ‡ï¼šè®©æœåŠ¡å™¨æ‹¥æœ‰â€œè®°å¿†â€"
    **â€œHTTP ä¸è®°å¾—ä½ æ˜¯è°ï¼Œä½†ä¸šåŠ¡å¿…é¡»è®°å¾—ä½ æ˜¯è°ã€‚â€** â€”â€” è¿™å°±æ˜¯ä¼šè¯æœºåˆ¶å­˜åœ¨çš„æ ¹æœ¬åŸå› ã€‚

    HTTP åè®®å¤©ç”Ÿæ˜¯**â€œå¥å¿˜â€çš„ï¼ˆæ— çŠ¶æ€ï¼‰**ã€‚å½“ä½ ç™»å½•äº†æ·˜å®ï¼Œåˆ·æ–°ä¸€ä¸‹é¡µé¢ï¼ŒæœåŠ¡å™¨å‡­ä»€ä¹ˆè¿˜èƒ½è®¤å‡ºâ€œè¿˜æ˜¯ä½ â€ï¼Ÿ
    
    ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæœ¬èŠ‚æˆ‘ä»¬å°†å­¦ä¹  Web å¼€å‘ä¸­çš„ä¸¤ç§æ ¸å¿ƒâ€œè®°å¿†æœ¯â€ï¼š
    
    * **Cookie**ï¼šæŠŠæ•°æ®å­˜åœ¨**ç”¨æˆ·å…œé‡Œ**ï¼ˆå®¢æˆ·ç«¯æŠ€æœ¯ï¼‰ã€‚
    * **Session**ï¼šæŠŠæ•°æ®å­˜åœ¨**æœåŠ¡å™¨ä¿é™©ç®±é‡Œ**ï¼ˆæœåŠ¡ç«¯æŠ€æœ¯ï¼‰ã€‚

---

## ğŸ¤¯ ç¬¬ä¸€æ­¥ï¼šä¸ºä»€ä¹ˆéœ€è¦ä¼šè¯è·Ÿè¸ªï¼Ÿ

HTTP åè®®æ˜¯**æ— çŠ¶æ€ (Stateless)** çš„ã€‚

æ‰“ä¸ªæ¯”æ–¹ï¼šHTTP æœåŠ¡å™¨å°±åƒä¸€ä¸ª**â€œå¤±å¿†çš„æ”¶é“¶å‘˜â€**ã€‚
1.  ä½ ä¹°äº†ä¸€ç“¶æ°´ï¼Œç»“è´¦ã€‚ï¼ˆè¯·æ±‚ Aï¼‰
2.  ä½ è½¬èº«åˆæ‹¿äº†ä¸€åŒ…è–¯ç‰‡ï¼Œå»ç»“è´¦ã€‚ï¼ˆè¯·æ±‚ Bï¼‰
3.  æ”¶é“¶å‘˜ä¼šé—®ï¼šâ€œå…ˆç”Ÿæ‚¨å¥½ï¼Œè¯·é—®æœ‰ä¼šå‘˜å¡å—ï¼Ÿâ€ â€”â€” **ä»–å®Œå…¨ä¸è®°å¾—åˆšæ‰æ¥å¾…è¿‡ä½ ï¼**

ä¸ºäº†è®©æœåŠ¡å™¨â€œè®°ä½â€ç”¨æˆ·ï¼ˆæ¯”å¦‚ä¿æŒç™»å½•çŠ¶æ€ã€è´­ç‰©è½¦å•†å“ï¼‰ï¼Œæˆ‘ä»¬éœ€è¦ç»™æ¯ä¸ªç”¨æˆ·å‘ä¸€ä¸ª**â€œä¿¡ç‰©â€**ã€‚

---

## ğŸª ç¬¬äºŒæ­¥ï¼šCookie (å®¢æˆ·ç«¯æŠ€æœ¯)

**Cookie** æ˜¯æœåŠ¡å™¨å‘é€ç»™æµè§ˆå™¨çš„ä¸€å°æ®µæ–‡æœ¬ä¿¡æ¯ã€‚æµè§ˆå™¨æŠŠå®ƒå­˜ä¸‹æ¥ï¼Œä»¥åæ¯æ¬¡è®¿é—®è¿™ä¸ªæœåŠ¡å™¨ï¼Œéƒ½ä¼šè‡ªåŠ¨å¸¦ä¸Šã€‚

### 1. æ ¸å¿ƒæœºåˆ¶
* **é¢å‘**ï¼šæœåŠ¡å™¨é€šè¿‡å“åº”å¤´ `Set-Cookie` ç»™æµè§ˆå™¨ã€‚
* **æºå¸¦**ï¼šæµè§ˆå™¨é€šè¿‡è¯·æ±‚å¤´ `Cookie` æŠŠæ•°æ®å¸¦å›ç»™æœåŠ¡å™¨ã€‚
* **é™åˆ¶**ï¼šåªèƒ½å­˜å­—ç¬¦ä¸²ï¼Œå¤§å°æœ‰é™ï¼ˆ4KBï¼‰ï¼Œä¸”ä¸å®‰å…¨ï¼ˆç”¨æˆ·å¯è§ï¼‰ã€‚

### 2. å®æˆ˜ä»£ç ï¼šâ€œè®°ä½ä¸Šæ¬¡è®¿é—®æ—¶é—´â€

```java title="CookieDemoServlet.java"
@WebServlet("/cookie-demo")
public class CookieDemoServlet extends HttpServlet {
    @Override
    protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws IOException {
        resp.setContentType("text/html;charset=utf-8");
        PrintWriter out = resp.getWriter();

        // 1. è·å– Cookie (æ³¨æ„ï¼šè¿”å›çš„æ˜¯æ•°ç»„ï¼Œå¯èƒ½ä¸º null)
        Cookie[] cookies = req.getCookies();
        boolean found = false;
        
        if (cookies != null) {
            for (Cookie c : cookies) {
                if ("lastTime".equals(c.getName())) {
                    out.write("æ¬¢è¿å›æ¥ï¼æ‚¨ä¸Šæ¬¡è®¿é—®æ—¶é—´æ˜¯ï¼š" + c.getValue());
                    found = true;
                    break;
                }
            }
        }
        
        if (!found) {
            out.write("æ‚¨æ˜¯ç¬¬ä¸€æ¬¡è®¿é—®æœ¬ç«™ï¼");
        }

        // 2. å‘é€æ–° Cookie (è®°å½•å½“å‰æ—¶é—´)
        // Cookie å€¼ä¸æ”¯æŒç©ºæ ¼å’Œç‰¹æ®Šå­—ç¬¦ï¼Œå»ºè®®ç”¨ URLEncoder ç¼–ç ï¼Œè¿™é‡Œç®€å•æ¼”ç¤ºç”¨å­—ç¬¦ä¸²
        String time = String.valueOf(System.currentTimeMillis());
        Cookie cookie = new Cookie("lastTime", time);
        
        // 3. è®¾ç½®å­˜æ´»æ—¶é—´ (å•ä½ï¼šç§’)
        // æ­£æ•°ï¼šå­˜æ´»å¤šä¹…ï¼›0ï¼šç«‹å³åˆ é™¤ï¼›è´Ÿæ•°ï¼šæµè§ˆå™¨å…³é—­å³å¤±æ•ˆ
        cookie.setMaxAge(60 * 60 * 24); // å­˜æ´» 1 å¤©
        
        // 4. åŠ å…¥å“åº”
        resp.addCookie(cookie);
    }
}

```

!!! warning "Cookie çš„å‘"
    * `req.getCookies()` å¦‚æœæ²¡æœ‰ Cookie ä¼šè¿”å› `null`ï¼Œä¸åˆ¤ç©ºä¼šæŠ¥ **NullPointerException**ã€‚
    * Cookie åªèƒ½å­˜ ASCII å­—ç¬¦ä¸²ï¼Œå­˜ä¸­æ–‡å¿…é¡»å…ˆç”¨ `URLEncoder.encode()` ç¼–ç ã€‚

---

## ğŸ” ç¬¬ä¸‰æ­¥ï¼šSession (æœåŠ¡ç«¯æŠ€æœ¯)

**Session** æ˜¯ Java Web æä¾›çš„**æœåŠ¡ç«¯**ä¼šè¯æŠ€æœ¯ã€‚å®ƒåœ¨æœåŠ¡å™¨å†…å­˜ä¸­ä¸ºæ¯ä¸ªç”¨æˆ·å¼€è¾Ÿäº†ä¸€ä¸ª**ç‹¬ç«‹çš„å‚¨ç‰©æŸœ**ã€‚

### 1. JSESSIONID æœºåˆ¶ (èƒŒè¯µå…¨æ–‡)

ç”¨æˆ·æ‰‹é‡Œåªæ‹¿ä¸€æŠŠ**é’¥åŒ™**ï¼ˆSession IDï¼‰ï¼Œå…·ä½“çš„æ•°æ®ï¼ˆå¦‚ç”¨æˆ·å¯¹è±¡ã€è´­ç‰©è½¦ï¼‰éƒ½åœ¨æœåŠ¡å™¨çš„æŸœå­é‡Œã€‚

```mermaid
sequenceDiagram
    autonumber
    participant C as æµè§ˆå™¨ (Client)
    participant S as æœåŠ¡å™¨ (Tomcat)

    Note over C, S: åœºæ™¯ï¼šç”¨æˆ·ç¬¬ä¸€æ¬¡è®¿é—®
    C->>S: å‘é€è¯·æ±‚ (ä¸å¸¦ ID)
    S->>S: 1. åˆ›å»º Session å¯¹è±¡<br/>2. ç”Ÿæˆå”¯ä¸€ ID: JSESSIONID=A101
    S-->>C: å“åº” (Set-Cookie: JSESSIONID=A101)
    
    Note over C, S: åœºæ™¯ï¼šç”¨æˆ·ç¬¬äºŒæ¬¡è®¿é—®
    C->>S: å‘é€è¯·æ±‚ (Cookie: JSESSIONID=A101)
    S->>S: 1. å‘ç° Cookie é‡Œæœ‰ ID<br/>2. åœ¨å†…å­˜é‡Œæ‰¾ ID=A101 çš„ Session<br/>3. æ‰¾åˆ°äº†ï¼å–å‡ºæ•°æ®
    S-->>C: å“åº”

```

### 2. å®æˆ˜ä»£ç ï¼šSession ç™»å½•æ ¡éªŒ

Session å¯ä»¥å­˜**ä»»æ„ç±»å‹**çš„å¯¹è±¡ï¼ˆObjectï¼‰ï¼Œéå¸¸é€‚åˆå­˜ç”¨æˆ·ä¿¡æ¯ã€‚

```java title="SessionDemoServlet.java"
@WebServlet("/session-demo")
public class SessionDemoServlet extends HttpServlet {
    @Override
    protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws IOException {
        // 1. è·å– Session
        // true(é»˜è®¤): æ²¡æœ‰å°±åˆ›å»ºæ–°çš„ï¼›false: æ²¡æœ‰å°±è¿”å› null
        HttpSession session = req.getSession();
        
        // 2. å­˜å…¥æ•°æ® (ç›¸å½“äºæŠŠä¸œè¥¿é”è¿›æŸœå­)
        session.setAttribute("username", "é™ˆè€å¸ˆ");
        session.setAttribute("role", "admin");
        
        // 3. å–å‡ºæ•°æ® (ä»æŸœå­é‡Œæ‹¿ä¸œè¥¿)
        String user = (String) session.getAttribute("username");
        
        // 4. é”€æ¯ Session (é€šå¸¸ç”¨äºé€€å‡ºç™»å½•)
        // session.invalidate(); 
        
        resp.getWriter().write("Session ID: " + session.getId());
    }
}

```

---

## âš”ï¸ ç¬¬å››æ­¥ï¼šCookie vs Session ç»ˆæå¯¹å†³

| ç‰¹æ€§ | Cookie | Session |
| --- | --- | --- |
| **å­˜å‚¨ä½ç½®** | **å®¢æˆ·ç«¯** (æµè§ˆå™¨) | **æœåŠ¡ç«¯** (æœåŠ¡å™¨å†…å­˜) |
| **å®‰å…¨æ€§** | ä½ (å®¹æ˜“è¢«ä¼ªé€ ã€æˆªè·) | **é«˜** (æ•°æ®åœ¨æœåŠ¡å™¨ï¼Œå®¢æˆ·ç«¯åªæœ‰ ID) |
| **å­˜å‚¨å®¹é‡** | å° (çº¦ 4KB) | å¤§ (å–å†³äºæœåŠ¡å™¨å†…å­˜) |
| **æ•°æ®ç±»å‹** | åªèƒ½ String | ä»»æ„ Object |
| **å¯¹æœåŠ¡å™¨å‹åŠ›** | æ—  | æœ‰ (ç”¨æˆ·å¤šäº†å†…å­˜å ç”¨å¤§) |
| **å…¸å‹åº”ç”¨** | â€œè®°ä½æˆ‘â€ã€è´­ç‰©è½¦(æœªç™»å½•)ã€å¹¿å‘Šè¿½è¸ª | **ç”¨æˆ·ç™»å½•çŠ¶æ€**ã€æ•æ„Ÿæ•°æ® |

!!! tip "æ¯”å–»è®°å¿†æ³•"
    * **Cookie** å°±åƒ **ä¼šå‘˜å¡**ï¼šå¡ä¸Šå†™ç€ä½ çš„åå­—å’Œç§¯åˆ†ï¼Œä½ è‡ªå·±è£…ç€ã€‚
    * **Session** å°±åƒ **å¥èº«æˆ¿å‚¨ç‰©æŸœ**ï¼šä½ åªæ‹¿ä¸€æŠŠæ‰‹ç‰Œå· (JSESSIONID)ï¼Œè¡£æœå’Œæ‰‹æœºéƒ½é”åœ¨å¥èº«æˆ¿é‡Œã€‚

---
## ğŸ§ª ç¬¬äº”æ­¥ï¼šéšå ‚å®éªŒ

!!! question "ç»ƒä¹ ï¼šç®€å•çš„ç™»å½• + é¦–é¡µéªŒè¯"
    **éœ€æ±‚**ï¼š

    1.  **LoginServlet**: æ¥æ”¶ç”¨æˆ·åã€‚å¦‚æœç™»å½•æˆåŠŸï¼Œå°†ç”¨æˆ·åå­˜å…¥ Sessionï¼š
        `session.setAttribute("user", username);`
    2.  **HomeServlet**: è¿™æ˜¯ä¸€ä¸ªå—ä¿æŠ¤çš„é¡µé¢ã€‚
        * å…ˆå°è¯•ä» Session è·å– "user"ã€‚
        * å¦‚æœä¸ä¸ºç©ºï¼šæ˜¾ç¤º "æ¬¢è¿å›æ¥ï¼Œxxx"ã€‚
        * å¦‚æœä¸ºç©ºï¼ˆæˆ– Session ä¸å­˜åœ¨ï¼‰ï¼šé‡å®šå‘å›ç™»å½•é¡µï¼Œå¹¶æç¤º "è¯·å…ˆç™»å½•"ã€‚

    ---

    > **ğŸ¤” æ€è€ƒ**ï¼šä¸ºä»€ä¹ˆå…³é—­æµè§ˆå™¨åå†æ‰“å¼€ï¼ŒSession å°±ä¸¢äº†ï¼Ÿ
    >
    > (æç¤ºï¼šå› ä¸ºå­˜ `JSESSIONID` çš„é‚£ä¸ª Cookie é»˜è®¤æ˜¯ä¼šè¯çº§çš„ï¼Œæµè§ˆå™¨ä¸€å…³å°±æ²¡äº†)ã€‚

---

## ğŸ“ æ€»ç»“

* **HTTP æ˜¯æ— çŠ¶æ€çš„**ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¼šè¯è·Ÿè¸ªã€‚
* **Cookie** æ•°æ®åœ¨å®¢æˆ·ç«¯ï¼Œä¸å®‰å…¨ï¼Œé€‚åˆå­˜ä¸é‡è¦çš„å°æ•°æ®ã€‚
* **Session** æ•°æ®åœ¨æœåŠ¡ç«¯ï¼Œå®‰å…¨ï¼Œä¾èµ– Cookie ä¼ è¾“ JSESSIONIDã€‚
* **æ ¸å¿ƒ API**:
    * `req.getCookies()` / `resp.addCookie()`
    * `req.getSession()` / `setAttribute()` / `getAttribute()`

---
[ä¸‹ä¸€èŠ‚ï¼šFilter è¿‡æ»¤å™¨ä¸ Listener ç›‘å¬å™¨](05-filter-listener.md){ .md-button .md-button--primary }



